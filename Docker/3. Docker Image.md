# Docker Image
### Download julia
```sh
[lvmh@localhost]$ mkdir ~/Desktop/temp
[lvmh@localhost]$ cd ~/Desktop/temp
[lvmh@localhost]$ wget https://julialang-s3.julialang.org/bin/linux/x64/1.0/julia-1.0.0-linux-x86_64.tar.gz
# 下載時間久
```

### 撰寫未優化的 Dockerfile
```sh
[lvmh@localhost]$ vi Dockerfile
FROM ubuntu:18.04
COPY julia-1.0.0-linux-x86_64.tar.gz /tmp
RUN apt-get update && apt-get install -y && \
    tar zxvf /tmp/julia-1.0.0-linux-x86_64.tar.gz -C /opt && \
    rm /tmp/julia-1.0.0-linux-x86_64.tar.gz && \
    ln -s /opt/julia-1.0.0/bin/julia /usr/bin/julia

[lvmh@localhost]$ docker rmi julia
[lvmh@localhost]$ docker build --no-cache -t julia .
```

### 檢視未優化的 Julia image
```sh
[lvmh@localhost]$ docker history julia
IMAGE           CREATED             CREATED BY                                      SIZE    COMMENT
6d56c5656d1b    About an hour ago   /bin/sh -c apt-get update && apt-get install…   350MB
39c184c28419    2 hours ago         /bin/sh -c #(nop) COPY file:9c0f24a51dc54d99…   88.9MB
93fd78260bd1    13 days ago         /bin/sh -c #(nop)  CMD ["/bin/bash"]            0B
<missing>       13 days ago         /bin/sh -c mkdir -p /run/systemd && echo 'do…'  7B
<missing>       13 days ago         /bin/sh -c rm -rf /var/lib/apt/lists/*          0B
<missing>       13 days ago         /bin/sh -c set -xe   && echo '#!/bin/sh' > /…   745B
<missing>       13 days ago         /bin/sh -c #(nop) ADD file:39e5bc157a8be63bb…   86.2MB

[lvmh@localhost]$ docker images julia
REPOSITORY  TAG     IMAGE ID        CREATED         SIZE
julia       latest  6d56c5656d1b    5 minutes ago   525MB
```

### 撰寫最佳化的 Dockerfile
```sh
[lvmh@localhost]$ vi Dockerfile
FROM ubuntu:18.04
ADD julia-1.0.0-linux-x86_64.tar.gz /opt
RUN ln -s /opt/julia-1.0.0/bin/julia /usr/bin/julia
[lvmh@localhost]$ docker rmi julia
[lvmh@localhost]$ docker build --no-cache -t julia .
```

### 檢視最佳化的 Julia image
```sh
[lvmh@localhost]$ docker history julia
IMAGE           CREATED              CREATED BY                                      SIZE   COMMENT
84bcf5cec932    About a minute ago   /bin/sh -c ln -s /opt/julia-1.0.0/bin/julia …   26B
7ed62270063b    About a minute ago   /bin/sh -c #(nop) ADD file:9c0f24a51dc54d994…   326MB
93fd78260bd1    13 days ago          /bin/sh -c #(nop)  CMD ["/bin/bash"]            0B
<missing>       13 days ago          /bin/sh -c mkdir -p /run/systemd && echo 'do…'  7B
<missing>       13 days ago          /bin/sh -c rm -rf /var/lib/apt/lists/*          0B
<missing>       13 days ago          /bin/sh -c set -xe   && echo '#!/bin/sh' > /…   745B
<missing>       13 days ago          /bin/sh -c #(nop) ADD file:39e5bc157a8be63bb…   86.2MB

[lvmh@localhost]$ docker images julia
REPOSITORY  TAG     IMAGE ID        CREATED         SIZE
julia       latest  84bcf5cec932    2 minutes ago   412MB
```

### 測試 Julia image
```sh
[lvmh@localhost]$ docker run --rm -it julia
root@container:/# julia
   _       _ _(_)_     |  Documentation: https://docs.julialang.org
  (_)     | (_) (_)    |
   _ _   _| |_  __ _   |  Type "?" for help, "]?" for Pkg help.
  | | | | | | |/ _  |  |
  | | |_| | | | (_| |  |  Version 1.0.0 (2018-08-08)
 _/ |\__'_|_|_|\__'_|  |  Official https://julialang.org/ release
|__/                   |

julia> CTRL + D
root@container:/# CTRL + D
```
# Docker Image 內定執行命令
### 檢視原廠 Image 內定執行命令
```sh
[lvmh@localhost]$ docker run --rm -it alpine
/ # Ctrl + D
[lvmh@localhost]$ docker run --rm -it busybox
/ # Ctrl + D
[lvmh@localhost]$ docker history alpine
IMAGE           CREATED         CREATED BY                                      SIZE    COMMENT
196d12cf6ab1    2 months ago    /bin/sh -c #(nop)  CMD ["/bin/sh"]              0B
<missing>       2 months ago    /bin/sh -c #(nop) ADD file:25c10b1d1b41d46a1…   4.41MB
[lvmh@localhost]$ docker history busybox
IMAGE           CREATED         CREATED BY                                      SIZE    COMMENT
59788edf1f3e    2 months ago    /bin/sh -c #(nop)  CMD ["sh"]                   0B
<missing>       2 months ago    /bin/sh -c #(nop) ADD file:63eebd629a5f7558c…   1.15MB
```

### 撰寫 alpine.base Dockerfile
```sh
[lvmh@localhost]$ cd ~/Desktop/ | mkdir alpine
[lvmh@localhost]$ vi alpine/Dockerfile
FROM alpine:3.8
RUN apk update && apk upgrade && apk add --no-cache wget curl tree elinks bash && \
    wget https://busybox.net/downloads/binaries/1.28.1-defconfig-multiarch/busybox-x86_64 && \
    chmod +x busybox-x86_64 && \
    mv busybox-x86_64 bin/busybox

CMD ["/bin/bash"]
```

### 建立與測試 alpine image
```sh
[lvmh@localhost]$ docker rmi alpine.base
[lvmh@localhost]$ docker build --no-cache -t alpine.base alpine/
[lvmh@localhost]$ docker run --rm -it alpine.base
bash-4.4# Ctrl + D
[lvmh@localhost]$ docker run --rm alpine.base hostname -i
172.17.0.2
[lvmh@localhost]$ docker history alpine.base
IMAGE           CREATED              CREATED BY                                      SIZE   COMMENT
f8bc71450a59    About a minute ago   /bin/sh -c #(nop)  CMD ["/bin/bash"]            0B
d6601570cde7    About a minute ago   /bin/sh -c apk update && apk upgrade &&     …   34MB
366107fe9de7    2 minutes ago        /bin/sh -c #(nop)  ENV ALPINE_VERSION=3.8       0B
196d12cf6ab1    2 months ago         /bin/sh -c #(nop)  CMD ["/bin/sh"]              0B
<missing>       2 months ago         /bin/sh -c #(nop) ADD file:25c10b1d1b41d46a1…   4.41MB
```

# 自製具有 Openssh Server 的 Docker image
### 撰寫 alpine.openssh Dockerfile
```sh
[lvmh@localhost]$ cd ~/Desktop | mkdir openssh
[lvmh@localhost]$ vi openssh/Dockerfile
FROM alpine.base
RUN apk update && apk upgrade && apk add --no-cache sudo openssh openrc \
    shadow procps util-linux coreutils binutils findutils grep && \
    # 設定 OpenSSH
    mkdir /run/openrc && mkdir /opt && touch /run/openrc/softlevel && rc-update add sshd && rc-status && \
    echo '#!/bin/bash' > /usr/bin/sshup && echo -e 'Welcome to Alpine 3.8\n' > /etc/motd && \
    echo '/etc/init.d/sshd start &>/dev/null && tail -f /dev/null' >> /usr/bin/sshup && chmod +x /usr/bin/sshup && \
    # 建立管理者帳號 bigred   
    adduser -s /bin/bash -h /home/lvmh -G wheel -D lvmh && echo 'lvmh:lvmh' | chpasswd && \
    echo '%wheel ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

ENTRYPOINT ["/usr/bin/sshup"]

[重要] ENTRYPOINT 所指定的執行命令, 在建立 Container 時強制執行此命令並且不可被其它命令取代
```

### 建立與測試  alpine.openssh image
```sh
[lvmh@localhost]$ docker rmi alpine.openssh
[lvmh@localhost]$ docker build --no-cache -t alpine.openssh openssh/
[lvmh@localhost]$ docker run --rm --name s1 -h s1 -d alpine.openssh
[lvmh@localhost]$ docker exec s1 hostname -i
172.17.0.2
[lvmh@localhost]$ rm ~/.ssh/known_hosts 
[lvmh@localhost]$ ssh lvmh@172.17.0.2
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '172.17.0.2' (ECDSA) to the list of known hosts.
lvmh@172.17.0.2 password: 
Welcome to Alpine 3.8

s1:~$ Ctrl + D
Connection to 172.17.0.2 closed.
[lvmh@localhost]$ docker stop s1

以下命令還是執行 /usr/bin/sshup, 不會執行 bash 命令
[lvmh@localhost]$ docker run --rm --name s1 alpine.openssh bash
```